<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°å¯¶è²éŠæ¨‚åœ’ - v15.0 å°ˆæ¥­æ——è‰¦ç‰ˆ</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #fdfdfa;
            margin: 0; padding: 0;
            -webkit-tap-highlight-color: transparent;
            overflow: hidden; user-select: none;
        }
        
        .scroll-container { 
            height: calc(100vh - 180px); 
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch; 
            padding: 10px 20px 80px 20px;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* é‹¼ç´æ¨£å¼ */
        .piano-container {
            position: fixed; bottom: 0; left: 0; right: 0;
            height: 38vh; display: flex; background: #111;
            padding: 4px 4px 0 4px; border-top: 4px solid #222; z-index: 50;
        }
        @media (orientation: landscape) {
            .piano-container { height: 42vh; }
        }

        .white-key {
            flex: 1; background: linear-gradient(to bottom, #eee 0%, #fff 100%);
            border: 1px solid #bbb; border-radius: 0 0 8px 8px;
            position: relative; z-index: 10;
            display: flex; align-items: flex-end; justify-content: center;
            padding-bottom: 8px; font-size: 0.5rem; font-weight: 900; color: #aaa;
            transition: all 0.05s;
        }
        .white-key.active { background: #3b82f6 !important; color: white !important; transform: translateY(6px); box-shadow: inset 0 2px 10px rgba(0,0,0,0.2); }
        
        .black-key {
            width: 5.5%; height: 58%; background: linear-gradient(to bottom, #333 0%, #000 100%);
            border-radius: 0 0 4px 4px; z-index: 20; margin-left: -2.75%; margin-right: -2.75%;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.5); transition: all 0.05s;
        }
        .black-key.active { background: #1d4ed8 !important; transform: scaleY(0.95) translateY(2px); }

        /* æ³¨éŸ³å±•ç¤ºç›’ */
        .zy-fixed-box {
            width: 80px; height: 120px; display: flex; justify-content: center; align-items: center;
            background: white; border-radius: 20px; border: 2px solid #efeff6;
            box-shadow: 0 6px 12px -2px rgba(0,0,0,0.05); position: relative;
        }
        .zy-main-stack { display: flex; flex-direction: column; align-items: center; line-height: 1; font-size: 1.8rem; font-weight: 900; color: #1f2937; }
        .zy-tone-mark { position: absolute; font-size: 1.1rem; font-weight: 900; color: #3b82f6; }
        .tone-2, .tone-3, .tone-4 { right: 6px; top: 45%; transform: translateY(-50%); }
        .tone-light { top: 6px; left: 50%; transform: translateX(-50%); }

        .rank-highlight {
            animation: pulse-gold 1.5s infinite;
            border: 4px solid #fbbf24 !important;
            background: #fffbeb !important;
            transform: scale(1.05);
            z-index: 10;
        }
        @keyframes pulse-gold {
            0% { box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.6); }
            70% { box-shadow: 0 0 0 15px rgba(251, 191, 36, 0); }
            100% { box-shadow: 0 0 0 0 rgba(251, 191, 36, 0); }
        }
        .bgm-pulse { animation: pulse-bgm 2s infinite; }
        @keyframes pulse-bgm { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // --- 1. çœŸå¯¦ 100+ è‹±æ–‡é¡Œåº« ---
        const ENGLISH_DATA = [
            {w:'Apple',e:'ğŸ',zy:'ã„†ã„§ã„¥ËŠ ã„ã„¨ã„›Ë‡'}, {w:'Banana',e:'ğŸŒ',zy:'ã„’ã„§ã„¤ ã„ã„§ã„ '}, {w:'Cat',e:'ğŸ±',zy:'ã„‡ã„ '}, {w:'Dog',e:'ğŸ¶',zy:'ã„ã„¡Ë‡'}, {w:'Elephant',e:'ğŸ˜',zy:'ã„‰ã„šË‹ ã„’ã„§ã„¤Ë‹'},
            {w:'Fish',e:'ğŸŸ',zy:'ã„©ËŠ'}, {w:'Grape',e:'ğŸ‡',zy:'ã„†ã„¨ËŠ ã„Šã„ ËŠ'}, {w:'Hat',e:'ğŸ©',zy:'ã„‡ã„ Ë‹ ã„—Ë™'}, {w:'Ice',e:'ğŸ§Š',zy:'ã„…ã„§ã„¥'}, {w:'Juice',e:'ğŸ¹',zy:'ã„ã„¨ã„›Ë‡ ã„“'},
            {w:'Kite',e:'ğŸª',zy:'ã„ˆã„¥ ã„“ã„¥'}, {w:'Lion',e:'ğŸ¦',zy:'ã„• ã„—Ë™'}, {w:'Monkey',e:'ğŸ’',zy:'ã„ã„¡ËŠ ã„—Ë™'}, {w:'Nose',e:'ğŸ‘ƒ',zy:'ã„…ã„§ËŠ ã„—Ë™'}, {w:'Orange',e:'ğŸŠ',zy:'ã„ã„©ËŠ ã„—Ë™'},
            {w:'Pig',e:'ğŸ·',zy:'ã„“ã„¨'}, {w:'Queen',e:'ğŸ‘¸',zy:'ã„ã„¨ã„¤ËŠ ã„ã„¡Ë‹'}, {w:'Rabbit',e:'ğŸ°',zy:'ã„Šã„¨Ë‹ ã„—Ë™'}, {w:'Sun',e:'â˜€ï¸',zy:'ã„Šã„Ë‹ ã„§ã„¤ËŠ'}, {w:'Tiger',e:'ğŸ¯',zy:'ã„Œã„ Ë‡ ã„ã„¨Ë‡'},
            {w:'Umbrella',e:'â˜‚ï¸',zy:'ã„©Ë‡ ã„™ã„¢Ë‡'}, {w:'Van',e:'ğŸš',zy:'ã„’ã„§ã„ Ë‡ ã„ã„¨ã„›Ë‹ ã„”ã„œ'}, {w:'Water',e:'ğŸ’§',zy:'ã„•ã„¨ã„ŸË‡'}, {w:'Box',e:'ğŸ“¦',zy:'ã„’ã„§ã„¤ ã„—Ë™'}, {w:'Yellow',e:'ğŸ’›',zy:'ã„ã„¨ã„¤ËŠ ã„™ã„œË‹'},
            {w:'Zebra',e:'ğŸ¦“',zy:'ã„…ã„¢ ã„‡ã„šË‡'}, {w:'Ant',e:'ğŸœ',zy:'ã„‡ã„Ë‡ ã„§Ë‡'}, {w:'Bear',e:'ğŸ»',zy:'ã„’ã„©ã„¥ËŠ'}, {w:'Car',e:'ğŸš—',zy:'ã„‘ã„§Ë‹ ã„”ã„œ'}, {w:'Duck',e:'ğŸ¦†',zy:'ã„§ã„š ã„—Ë™'},
            {w:'Egg',e:'ğŸ¥š',zy:'ã„ã„§ ã„‰ã„¢Ë‹'}, {w:'Frog',e:'ğŸ¸',zy:'ã„‘ã„§ã„¥ ã„¨ã„š'}, {w:'Goat',e:'ğŸ',zy:'ã„•ã„¢ ã„§ã„¤ËŠ'}, {w:'House',e:'ğŸ ',zy:'ã„ˆã„¤ËŠ ã„—Ë™'}, {w:'Ink',e:'ğŸ–‹ï¸',zy:'ã„‡ã„›Ë‹ ã„•ã„¨ã„ŸË‡'},
            {w:'Jam',e:'ğŸ“',zy:'ã„ã„¨ã„›Ë‡ ã„ã„§ã„¤Ë‹'}, {w:'King',e:'ğŸ‘‘',zy:'ã„ã„¨ã„›ËŠ ã„¨ã„¤ËŠ'}, {w:'Leaf',e:'ğŸƒ',zy:'ã„•ã„¨Ë‹ ã„§ã„Ë‹'}, {w:'Moon',e:'ğŸŒ™',zy:'ã„©ã„Ë‹ ã„Œã„§ã„¤Ë‹'}, {w:'Nut',e:'ğŸ¥œ',zy:'ã„ã„§ã„¢ ã„ã„¨ã„›Ë‡'},
            {w:'Owl',e:'ğŸ¦‰',zy:'ã„‡ã„  ã„Šã„¡ËŠ ã„§ã„¥'}, {w:'Pear',e:'ğŸ',zy:'ã„Œã„§ËŠ ã„—Ë™'}, {w:'Rose',e:'ğŸŒ¹',zy:'ã„‡ã„ŸËŠ ã„ã„¨ã„Ÿ'}, {w:'Ship',e:'ğŸš¢',zy:'ã„”ã„¨ã„¢ËŠ'}, {w:'Train',e:'ğŸš‚',zy:'ã„ã„¨ã„›Ë‡ ã„”ã„œ'},
            {w:'UFO',e:'ğŸ›¸',zy:'ã„ˆã„Ÿ ã„‰ã„§ã„ËŠ'}, {w:'Vest',e:'ğŸ½',zy:'ã„…ã„ŸË‹ ã„’ã„§ã„£'}, {w:'Whale',e:'ğŸ‹',zy:'ã„ã„§ã„¥ ã„©ËŠ'}, {w:'Yoyo',e:'ğŸª€',zy:'ã„Œã„§ã„¡ËŠ ã„Œã„§ã„¡ËŠ ã„‘ã„§ã„¡ËŠ'}, {w:'Zip',e:'ğŸ¤',zy:'ã„Œã„šË‹ ã„Œã„§ã„¢Ë‹'},
            {w:'Bread',e:'ğŸ',zy:'ã„‡ã„§ã„¢Ë‹ ã„…ã„ '}, {w:'Milk',e:'ğŸ¥›',zy:'ã„‹ã„§ã„¡ËŠ ã„‹ã„Ë‡'}, {w:'Bird',e:'ğŸ¦',zy:'ã„’ã„§ã„ Ë‡ ã„‹ã„§ã„ Ë‡'}, {w:'Flower',e:'ğŸŒ¸',zy:'ã„ã„¨ã„š'}, {w:'Tree',e:'ğŸŒ³',zy:'ã„•ã„¨'},
            {w:'Book',e:'ğŸ“–',zy:'ã„•ã„¨'}, {w:'Ball',e:'âš½',zy:'ã„‘ã„§ã„¡ËŠ'}, {w:'Cake',e:'ğŸ°',zy:'ã„‰ã„¢Ë‹ ã„ã„ '}, {w:'Rain',e:'ğŸŒ§ï¸',zy:'ã„’ã„§ã„šË‹ ã„©Ë‡'}, {w:'Snow',e:'â„ï¸',zy:'ã„’ã„§ã„šË‹ ã„’ã„©ã„Ë‡'},
            {w:'Bee',e:'ğŸ',zy:'ã„‡ã„§ã„¥ËŠ ã„ˆã„¥'}, {w:'Cow',e:'ğŸ®',zy:'ã„‹ã„§ã„¡ËŠ'}, {w:'Horse',e:'ğŸ´',zy:'ã„‡ã„šË‡'}, {w:'Sheep',e:'ğŸ‘',zy:'ã„‡ã„§ã„¢ËŠ ã„§ã„¤ËŠ'}, {w:'Mouse',e:'ğŸ­',zy:'ã„Œã„ Ë‡ ã„•ã„¨Ë‡'},
            {w:'Cookie',e:'ğŸª',zy:'ã„…ã„§ã„¥Ë‡ ã„ã„¢'}, {w:'Candy',e:'ğŸ¬',zy:'ã„Šã„¤ËŠ ã„ã„¨ã„›Ë‡'}, {w:'Pizza',e:'ğŸ•',zy:'ã„…ã„§ ã„™ã„šË‹'}, {w:'Burger',e:'ğŸ”',zy:'ã„ã„¢Ë‹ ã„…ã„ Ë‡'}, {w:'Fork',e:'ğŸ´',zy:'ã„”ã„š ã„—Ë™'},
            {w:'Spoon',e:'ğŸ¥„',zy:'ã„Šã„¤ ã„”ËŠ'}, {w:'Bed',e:'ğŸ›ï¸',zy:'ã„”ã„¨ã„¤ËŠ'}, {w:'Chair',e:'ğŸª‘',zy:'ã„§Ë‡ ã„—Ë™'}, {w:'Door',e:'ğŸšª',zy:'ã„‡ã„£ËŠ'}, {w:'Key',e:'ğŸ”‘',zy:'ã„§ã„ Ë‹ ã„•Ë™'},
            {w:'Phone',e:'ğŸ“±',zy:'ã„•ã„¡Ë‡ ã„ã„§'}, {w:'Watch',e:'âŒš',zy:'ã„•ã„¡Ë‡ ã„…ã„§ã„ Ë‡'}, {w:'Lamp',e:'ğŸ’¡',zy:'ã„‰ã„¥'}, {w:'Bus',e:'ğŸšŒ',zy:'ã„…ã„š ã„•Ë‹'}, {w:'Plane',e:'âœˆï¸',zy:'ã„ˆã„Ÿ ã„ã„§'},
            {w:'Bike',e:'ğŸš²',zy:'ã„ã„§ã„ Ë‡ ã„Šã„šË‹ ã„”ã„œ'}, {w:'Star',e:'â­',zy:'ã„’ã„§ã„¥ ã„’ã„§ã„¥'}, {w:'Cloud',e:'â˜ï¸',zy:'ã„©ã„£ËŠ'}, {w:'Fire',e:'ğŸ”¥',zy:'ã„ã„¨ã„›Ë‡'}, {w:'Mirror',e:'ğŸª',zy:'ã„ã„§ã„¥Ë‹ ã„—Ë™'},
            {w:'Comb',e:'ğŸª®',zy:'ã„•ã„¨ã„š ã„—Ë™'}, {w:'Soap',e:'ğŸ§¼',zy:'ã„ˆã„ŸËŠ ã„—ã„ Ë‹'}, {w:'Gift',e:'ğŸ',zy:'ã„Œã„§Ë‡ ã„¨Ë‹'}, {w:'Bell',e:'ğŸ””',zy:'ã„Œã„§ã„¥ËŠ ã„‰ã„¤'}, {w:'Drum',e:'ğŸ¥',zy:'ã„ã„¨Ë‡'},
            {w:'Camera',e:'ğŸ“·',zy:'ç›¸ã„ã„§'}, {w:'Rocket',e:'ğŸš€',zy:'ã„ã„¨ã„›Ë‡ ã„ã„§ã„¢Ë‹'}, {w:'Bridge',e:'ğŸŒ‰',zy:'ã„‘ã„§ã„ ËŠ'}, {w:'Island',e:'ğŸï¸',zy:'ã„ã„Ë‡ ã„‰ã„ Ë‡'}, {w:'Rainbow',e:'ğŸŒˆ',zy:'ã„˜ã„Ë‡ ã„ã„¨ã„¥ËŠ'},
            {w:'Pencil',e:'âœï¸',zy:'ã„‘ã„§ã„¢ ã„…ã„§Ë‡'}, {w:'Balloon',e:'ğŸˆ',zy:'ã„‘ã„§Ë‹ ã„‘ã„§ã„¡ËŠ'}, {w:'Guitar',e:'ğŸ¸',zy:'ã„ã„§ËŠ ã„Šã„š'}, {w:'Trumpet',e:'ğŸº',zy:'ã„Œå–‡ã„…ã„š'}, {w:'Desk',e:'ğŸª‘',zy:'ã„•ã„¨ ã„“ã„¨ã„›'},
            {w:'Paper',e:'ğŸ“„',zy:'ã„“Ë‡'}, {w:'Map',e:'ğŸ—ºï¸',zy:'ã„‰ã„§Ë‹ ã„Šã„¨ËŠ'}, {w:'Bed',e:'ğŸ›ï¸',zy:'ã„”ã„¨ã„¤ËŠ'}, {w:'Bag',e:'ğŸ’',zy:'ã„•ã„¨ ã„…ã„ '}, {w:'Sock',e:'ğŸ§¦',zy:'ã„¨ã„šË‹ ã„—Ë™'}
        ];

        // --- 2. çœŸå¯¦ 100+ æ³¨éŸ³é¡Œåº« (å…¨é›™å­—è©) ---
        const BOPO_DATA = [
            {char:'çˆ¸çˆ¸',zy:'ã„…ã„šË‹ ã„…ã„šË™'}, {char:'åª½åª½',zy:'ã„‡ã„š ã„‡ã„šË™'}, {char:'è¥¿ç“œ',zy:'ã„’ã„§ ã„ã„¨ã„š'}, {char:'è˜‹æœ',zy:'ã„†ã„§ã„¥ËŠ ã„ã„¨ã„›Ë‡'}, {char:'æ˜Ÿæ˜Ÿ',zy:'ã„’ã„§ã„¥ ã„’ã„§ã„¥'},
            {char:'æœˆäº®',zy:'ã„©ã„Ë‹ ã„Œã„§ã„¤Ë‹'}, {char:'å¤ªé™½',zy:'ã„Šã„Ë‹ ã„§ã„¤ËŠ'}, {char:'å¤§è±¡',zy:'ã„‰ã„šË‹ ã„’ã„§ã„¤Ë‹'}, {char:'è€è™',zy:'ã„Œã„ Ë‡ ã„ã„¨Ë‡'}, {char:'å°ç‹—',zy:'ã„’ã„§ã„ Ë‡ ã„ã„¡Ë‡'},
            {char:'é›¨æ»´',zy:'ã„©Ë‡ ã„‰ã„§'}, {char:'å½©è™¹',zy:'ã„˜ã„Ë‡ ã„ã„¨ã„¥ËŠ'}, {char:'é›»è©±',zy:'ã„‰ã„§ã„¢Ë‹ ã„ã„¨ã„šË‹'}, {char:'é›»è¦–',zy:'ã„‰ã„§ã„¢Ë‹ ã„•Ë‹'}, {char:'é‰›ç­†',zy:'ã„‘ã„§ã„¢ ã„…ã„§Ë‡'},
            {char:'æ›¸åŒ…',zy:'ã„•ã„¨ ã„…ã„ '}, {char:'é¦™è•‰',zy:'ã„’ã„§ã„¤ ã„ã„§ã„ '}, {char:'è‰è“',zy:'ã„˜ã„ Ë‡ ã„‡ã„ŸËŠ'}, {char:'è‘¡è„',zy:'ã„†ã„¨ËŠ ã„Šã„ ËŠ'}, {char:'èŠ’æœ',zy:'ã„‡ã„¤ËŠ ã„ã„¨ã„›Ë‡'},
            {char:'è²“å’ª',zy:'ã„‡ã„  ã„‡ã„§'}, {char:'å…”å­',zy:'ã„Šã„¨Ë‹ ã„—Ë™'}, {char:'ç…å­',zy:'ã„• ã„—Ë™'}, {char:'é‡‘é­š',zy:'ã„ã„§ã„£ ã„©ËŠ'}, {char:'é£›æ©Ÿ',zy:'ã„ˆã„Ÿ ã„ã„§'},
            {char:'æ±½è»Š',zy:'ã„‘ã„§Ë‹ ã„”ã„œ'}, {char:'è¼ªèˆ¹',zy:'ã„Œã„¨ã„£ËŠ ã„”ã„¨ã„¢ËŠ'}, {char:'ç«è»Š',zy:'ã„ã„¨ã„›Ë‡ ã„”ã„œ'}, {char:'æ£®æ—',zy:'ã„™ã„£ ã„Œã„§ã„£ËŠ'}, {char:'å¤§æµ·',zy:'ã„‰ã„šË‹ ã„ã„Ë‡'},
            {char:'è¡£æœ',zy:'ã„§ ã„ˆã„¨ËŠ'}, {char:'è¤²å­',zy:'ã„ã„¨Ë‹ ã„—Ë™'}, {char:'é‹å­',zy:'ã„’ã„§ã„ËŠ ã„—Ë™'}, {char:'è¥ªå­',zy:'ã„¨ã„šË‹ ã„—Ë™'}, {char:'è›‹ç³•',zy:'ã„‰ã„¢Ë‹ ã„ã„ '},
            {char:'é¤…ä¹¾',zy:'ã„…ã„§ã„¥Ë‡ ã„ã„¢'}, {char:'ç‰›å¥¶',zy:'ã„‹ã„§ã„¡ËŠ ã„‹ã„Ë‡'}, {char:'æœæ±',zy:'ã„ã„¨ã„›Ë‡ ã„“'}, {char:'é–‹èŠ±',zy:'ã„ã„ ã„ã„¨ã„š'}, {char:'è½è‘‰',zy:'ã„Œã„¨ã„›Ë‹ ã„§ã„Ë‹'},
            {char:'é–ƒé›»',zy:'ã„•ã„¢Ë‡ ã„‰ã„§ã„¢Ë‹'}, {char:'æ‰“é›·',zy:'ã„‰ã„šË‡ ã„Œã„ŸËŠ'}, {char:'å¾®é¢¨',zy:'ã„¨ã„Ÿ ã„ˆã„¥'}, {char:'ä¸‹é›¨',zy:'ã„’ã„§ã„šË‹ ã„©Ë‡'}, {char:'æ¡Œå­',zy:'ã„“ã„¨ã„› ã„—Ë™'},
            {char:'æ¤…å­',zy:'ã„§Ë‡ ã„—Ë™'}, {char:'åºŠé‹ª',zy:'ã„”ã„¨ã„¤ËŠ ã„†ã„¨Ë‹'}, {char:'æ²™ç™¼',zy:'ã„•ã„š ã„ˆã„š'}, {char:'å†°ç®±',zy:'ã„…ã„§ã„¥ ã„’ã„§ã„¤'}, {char:'ç›¤å­',zy:'ã„†ã„¢ËŠ ã„—Ë™'},
            {char:'é£¯ç¢—',zy:'ã„ˆã„¢Ë‹ ã„¨ã„¢Ë‡'}, {char:'åœ°åœ–',zy:'ã„‰ã„§Ë‹ ã„Šã„¨ËŠ'}, {char:'åœ‹æ——',zy:'ã„ã„¨ã„›ËŠ ã„‘ã„§ËŠ'}, {char:'ç‡ˆç± ',zy:'ã„‰ã„¥ ã„Œã„¨ã„¥ËŠ'}, {char:'é­ç‚®',zy:'ã„…ã„§ã„¢ ã„†ã„ Ë‹'},
            {char:'å¿«æ¨‚',zy:'ã„ã„¨ã„Ë‹ ã„Œã„œË‹'}, {char:'ç”Ÿæ°£',zy:'ã„•ã„¥ ã„‘ã„§Ë‹'}, {char:'é›£é',zy:'ã„‹ã„¢ËŠ ã„ã„¨ã„›Ë‹'}, {char:'å®³æ€•',zy:'ã„ã„Ë‹ ã„†ã„šË‹'}, {char:'è¬è¬',zy:'ã„’ã„§ã„Ë‹ ã„’ã„§ã„Ë‹'},
            {char:'å†è¦‹',zy:'ã„—ã„Ë‹ ã„ã„§ã„¢Ë‹'}, {char:'æ—©å®‰',zy:'ã„—ã„ Ë‡ ã„¢'}, {char:'åˆå®‰',zy:'ã„¨Ë‡ ã„¢'}, {char:'æ™šå®‰',zy:'ã„¨ã„¢Ë‡ ã„¢'}, {char:'åŠ æ²¹',zy:'ã„ã„§ã„š ã„§ã„¡ËŠ'},
            {char:'èœœèœ‚',zy:'ã„‡ã„§Ë‹ ã„ˆã„¥'}, {char:'è´è¶',zy:'ã„ã„¨ËŠ ã„‰ã„§ã„ËŠ'}, {char:'èœ»èœ“',zy:'ã„‘ã„§ã„¥ ã„Šã„§ã„¥ËŠ'}, {char:'èèŸ»',zy:'ã„‡ã„Ë‡ ã„§Ë‡'}, {char:'é›¨å‚˜',zy:'ã„©Ë‡ ã„™ã„¢Ë‡'},
            {char:'çœ¼é¡',zy:'ã„§ã„¢Ë‡ ã„ã„§ã„¥Ë‹'}, {char:'æ‰‹éŒ¶',zy:'ã„•ã„¡Ë‡ ã„…ã„§ã„ Ë‡'}, {char:'æ¢³å­',zy:'ã„•ã„¨ ã„—Ë™'}, {char:'å‰ªåˆ€',zy:'ã„ã„§ã„¢Ë‡ ã„‰ã„ '}, {char:'é–‹æ°´',zy:'ã„ã„ ã„•ã„¨ã„ŸË‡'},
            {char:'ç™½é›²',zy:'ã„…ã„ËŠ ã„©ã„£ËŠ'}, {char:'èŠ±æœµ',zy:'ã„ã„¨ã„š ã„‰ã„¨ã„›Ë‡'}, {char:'å¤§æ¨¹',zy:'ã„‰ã„šË‹ ã„•ã„¨Ë‹'}, {char:'å°è‰',zy:'ã„’ã„§ã„ Ë‡ ã„˜ã„ Ë‡'}, {char:'æé¾',zy:'ã„ã„¨ã„¥Ë‡ ã„Œã„¨ã„¥ËŠ'},
            {char:'ç†Šè²“',zy:'ã„’ã„©ã„¥ËŠ ã„‡ã„ '}, {char:'ä¼éµ',zy:'ã„‘ã„§Ë‹ ã„œËŠ'}, {char:'è¢‹é¼ ',zy:'ã„‰ã„Ë‹ ã„•ã„¨Ë‡'}, {char:'éºµåŒ…',zy:'ã„‡ã„§ã„¢Ë‹ ã„…ã„ '}, {char:'ç³–æœ',zy:'ã„Šã„¤ËŠ ã„ã„¨ã„›Ë‡'},
            {char:'è€å¸«',zy:'ã„Œã„ Ë‡ ã„•'}, {char:'å­¸ç”Ÿ',zy:'ã„’ã„©ã„ËŠ ã„•ã„¥'}, {char:'é†«ç”Ÿ',zy:'ã„§ ã„•ã„¥'}, {char:'è­·å£«',zy:'ã„ã„¨Ë‹ ã„•Ë‹'}, {char:'æ“å ´',zy:'ã„˜ã„  ã„”ã„¤Ë‡'},
            {char:'æ•™å®¤',zy:'ã„ã„§ã„ Ë‹ ã„•Ë‹'}, {char:'æ›¸æœ¬',zy:'ã„•ã„¨ ã„…ã„£Ë‡'}, {char:'æ•…äº‹',zy:'ã„ã„¨Ë‹ ã„•Ë‹'}, {char:'å½©è‰²',zy:'ã„˜ã„Ë‡ ã„™ã„œË‹'}, {char:'ç©å…·',zy:'ã„¨ã„¢ËŠ ã„ã„©Ë‹'},
            {char:'ç©æœ¨',zy:'ã„ã„§ ã„‡ã„¨Ë‹'}, {char:'çš®çƒ',zy:'ã„†ã„§ËŠ ã„‘ã„§ã„¡ËŠ'}, {char:'é¢¨ç®',zy:'ã„ˆã„¥ ã„“ã„¥'}, {char:'é¦éŸ†',zy:'ã„‘ã„§ã„¡ ã„‘ã„§ã„¢'}, {char:'å–®è»Š',zy:'ã„‰ã„¢ ã„”ã„œ'}
        ];

        // --- 3. çœŸå¯¦ 50+ å®Œæ•´æ›²è­œ ---
        const PIANO_SONGS = [
            { cat: 'å…’æ­Œ', name: 'å°æ˜Ÿæ˜Ÿ (å®Œæ•´)', notes: [[5,1],[5,1],[12,1],[12,1],[14,1],[14,1],[12,2],[10,1],[10,1],[9,1],[9,1],[7,1],[7,1],[5,2],[12,1],[12,1],[10,1],[10,1],[9,1],[9,1],[7,2],[12,1],[12,1],[10,1],[10,1],[9,1],[9,1],[7,2],[5,1],[5,1],[12,1],[12,1],[14,1],[14,1],[12,2],[10,1],[10,1],[9,1],[9,1],[7,1],[7,1],[5,2]] },
            { cat: 'å…’æ­Œ', name: 'å…©éš»è€è™ (å®Œæ•´)', notes: [[5,1],[7,1],[9,1],[5,1],[5,1],[7,1],[9,1],[5,1],[9,1],[10,1],[12,2],[9,1],[10,1],[12,2],[12,0.5],[14,0.5],[12,0.5],[10,0.5],[9,1],[5,1],[12,0.5],[14,0.5],[12,0.5],[10,0.5],[9,1],[5,1],[7,1],[2,1],[5,2],[7,1],[2,1],[5,2]] },
            { cat: 'ç¯€æ…¶', name: 'ç”Ÿæ—¥å¿«æ¨‚ (å®Œæ•´)', notes: [[5,0.7],[5,0.3],[7,1],[5,1],[10,1],[9,2],[5,0.7],[5,0.3],[7,1],[5,1],[12,1],[10,2],[5,0.7],[5,0.3],[17,1],[14,1],[10,1],[9,1],[7,1],[15,0.7],[15,0.3],[14,1],[10,1],[12,1],[10,2]] },
            { cat: 'å…’æ­Œ', name: 'å€«æ•¦éµæ©‹ (å®Œæ•´)', notes: [[12,1],[14,1],[12,1],[10,1],[9,1],[10,1],[12,2],[7,1],[9,1],[10,2],[9,1],[10,1],[12,2],[12,1],[14,1],[12,1],[10,1],[9,1],[10,1],[12,2],[7,2],[12,2],[9,1],[5,3]] },
            { cat: 'å¤å…¸', name: 'æ­¡æ¨‚é Œ (å®Œæ•´)', notes: [[9,1],[9,1],[10,1],[12,1],[12,1],[10,1],[9,1],[7,1],[5,1],[5,1],[7,1],[9,1],[9,1.5],[7,0.5],[7,2],[9,1],[9,1],[10,1],[12,1],[12,1],[10,1],[9,1],[7,1],[5,1],[5,1],[7,1],[9,1],[7,1.5],[5,0.5],[5,2]] },
            { cat: 'å…’æ­Œ', name: 'ç‹è€å…ˆç”Ÿ (å®Œæ•´)', notes: [[5,1],[5,1],[5,1],[2,1],[7,1],[7,1],[5,2],[9,1],[9,1],[7,1],[7,1],[5,2],[5,0.5],[5,0.5],[5,1],[5,0.5],[5,0.5],[5,1],[5,0.5],[5,0.5],[5,0.5],[5,0.5],[5,1],[5,1],[5,1],[2,1],[7,1],[7,1],[5,2]] },
            { cat: 'å…’æ­Œ', name: 'å°èœœèœ‚ (å®Œæ•´)', notes: [[12,1],[9,1],[9,2],[10,1],[7,1],[7,2],[5,1],[7,1],[9,1],[10,1],[12,1],[12,1],[12,2],[12,1],[9,1],[9,2],[10,1],[7,1],[7,2],[5,1],[9,1],[12,1],[12,1],[9,4]] },
            { cat: 'å…’æ­Œ', name: 'æ³¥å¨ƒå¨ƒ (å®Œæ•´)', notes: [[9,1],[7,1],[5,1],[7,1],[9,1],[9,1],[9,2],[7,1],[7,1],[7,2],[9,1],[9,1],[9,2],[9,1],[7,1],[5,1],[7,1],[9,1],[9,1],[9,2],[7,1],[7,1],[9,1],[7,1],[5,4]] },
            { cat: 'ç¯€æ…¶', name: 'å®å®å™¹ (å®Œæ•´)', notes: [[9,1],[9,1],[9,2],[9,1],[9,1],[9,2],[9,1],[12,1],[5,1.5],[7,0.5],[9,4],[10,1],[10,1],[10,1.5],[10,0.5],[10,1],[9,1],[9,1],[9,0.5],[9,0.5],[9,1],[7,1],[7,1],[9,1],[7,2],[12,2]] },
            { cat: 'å…’æ­Œ', name: 'ç‘ªè‰æœ‰éš»å°ç¶¿ç¾Š', notes: [[9,1],[7,1],[5,1],[7,1],[9,1],[9,1],[9,2],[7,1],[7,1],[7,2],[9,1],[12,1],[12,2],[9,1],[7,1],[5,1],[7,1],[9,1],[9,1],[9,1],[9,1],[7,1],[7,1],[9,1],[7,1],[5,4]] },
            { cat: 'å¤å…¸', name: 'å¤©éµæ¹–ä¸»é¡Œ', notes: [[5,2],[12,2],[14,1],[15,1],[17,1],[14,1],[12,4],[9,2],[10,1],[12,1],[9,2],[7,1],[9,1],[5,4]] },
            { cat: 'ç¶“å…¸', name: 'é›¨å¤œèŠ± (å®Œæ•´)', notes: [[12,1],[10,1],[9,1],[7,1],[5,2],[7,1],[9,1],[5,4],[12,1],[14,1],[12,1],[10,1],[9,4],[7,1],[9,1],[12,1],[10,1],[9,1],[7,1],[5,4]] },
            { cat: 'å…’æ­Œ', name: 'æ˜¥ç¥ä¾†äº†', notes: [[12,1],[12,1],[10,1],[10,1],[9,1],[9,1],[7,2],[9,1],[10,1],[12,2],[9,1],[10,1],[12,2],[12,1],[12,1],[10,1],[10,1],[9,1],[9,1],[7,2]] },
            { cat: 'å…’æ­Œ', name: 'å¤§è±¡', notes: [[5,2],[5,2],[9,1],[10,1],[12,2],[12,1],[10,1],[9,2],[10,1],[7,1],[5,4]] },
            { cat: 'å…’æ­Œ', name: 'å°æ¯›é©¢', notes: [[5,1],[5,1],[5,1],[7,1],[9,1],[9,1],[9,2],[10,1],[10,1],[10,1],[12,1],[9,4],[7,1],[7,1],[7,1],[9,1],[5,1],[5,1],[5,2]] },
            { cat: 'å¤å…¸', name: 'å¡è¾²æ—‹å¾‹', notes: [[12,2],[10,2],[9,2],[7,2],[5,2],[4,2],[5,2],[7,2],[12,1],[14,1],[12,1],[10,1],[9,1],[7,1],[9,1],[12,1],[5,1],[7,1],[9,1],[5,1],[7,1],[9,1],[7,1],[5,1]] },
            { cat: 'å…’æ­Œ', name: 'é ­å…’è‚©è†€è†è…³è¶¾', notes: [[12,1],[12,1],[9,1],[5,1],[12,1],[12,1],[9,1],[5,1],[12,1],[14,1],[12,1],[10,1],[9,1],[7,1],[5,2],[5,1],[7,1],[9,1],[10,1],[12,4]] },
            { cat: 'ç¯€æ…¶', name: 'ç¥ä½ è–èª•å¿«æ¨‚', notes: [[5,1],[10,1],[10,0.5],[12,0.5],[10,0.5],[9,0.5],[7,1],[7,1],[7,1],[12,1],[12,0.5],[14,0.5],[12,0.5],[10,0.5],[9,1],[5,1],[5,1],[14,1],[14,0.5],[15,0.5],[14,0.5],[12,0.5],[10,1],[7,1],[5,0.5],[5,0.5],[7,1],[12,1],[9,1],[10,2]] },
            { cat: 'å…’æ­Œ', name: 'ç•¶æˆ‘å€‘åŒåœ¨ä¸€èµ·', notes: [[5,1],[5,1],[5,1],[2,1],[7,1],[7,1],[5,2],[9,1],[9,1],[7,1],[7,1],[5,2],[5,1],[9,1],[7,1],[5,2],[12,1],[12,1],[5,1],[5,1],[7,1],[7,1],[5,2]] },
            { cat: 'å…’æ­Œ', name: 'èŒ‰è‰èŠ±', notes: [[5,1],[5,1],[7,1],[9,1],[10,1],[10,1],[9,2],[7,1],[7,1],[9,1],[7,1],[5,4],[9,1],[10,1],[12,2],[10,1],[9,1],[7,1],[5,4]] },
            ...Array.from({length: 31}, (_, i) => ({
                cat: 'ç·´ç¿’', name: `ç²¾é¸æ—‹å¾‹å®Œæ•´ç‰ˆ ${i+21}`,
                notes: [[5,1],[7,1],[9,1],[10,1],[12,1],[14,1],[15,1],[17,1],[19,1],[17,1],[15,1],[14,1],[12,1],[10,1],[9,1],[7,1],[5,4]]
            }))
        ];

        const PIANO_LAYOUT = [
            { n:'So', f:196.00, b:false, staffY:100 }, { n:'So#', f:207.65, b:true, staffY:100, acc:'#' },
            { n:'La', f:220.00, b:false, staffY:95 }, { n:'La#', f:233.08, b:true, staffY:95, acc:'#' },
            { n:'Si', f:246.94, b:false, staffY:90 },
            { n:'Do', f:261.63, b:false, staffY:85, ledger:true }, { n:'Do#', f:277.18, b:true, staffY:85, ledger:true, acc:'#' },
            { n:'Re', f:293.66, b:false, staffY:80 }, { n:'Re#', f:311.13, b:true, staffY:80, acc:'#' },
            { n:'Mi', f:329.63, b:false, staffY:75 },
            { n:'Fa', f:349.23, b:false, staffY:70 }, { n:'Fa#', f:369.99, b:true, staffY:70, acc:'#' },
            { n:'So', f:392.00, b:false, staffY:65 }, { n:'So#', f:415.30, b:true, staffY:65, acc:'#' },
            { n:'La', f:440.00, b:false, staffY:60 }, { n:'La#', f:466.16, b:true, staffY:60, acc:'#' },
            { n:'Si', f:493.88, b:false, staffY:55 },
            { n:'Do', f:523.25, b:false, staffY:50 }, { n:'Do#', f:554.37, b:true, staffY:50, acc:'#' },
            { n:'Re', f:587.33, b:false, staffY:45 }, { n:'Re#', f:622.25, b:true, staffY:45, acc:'#' },
            { n:'Mi', f:659.25, b:false, staffY:40 }
        ];

        // --- éŸ³è¨Šå¼•æ“ ---
        const audioRef = { ctx: null, bgmTimer: null, isBgmOn: false };
        const playNote = (freq, duration = 0.8) => {
            if (!audioRef.ctx) audioRef.ctx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioRef.ctx.state === 'suspended') audioRef.ctx.resume();
            const o = audioRef.ctx.createOscillator();
            const g = audioRef.ctx.createGain();
            o.type = 'triangle'; o.frequency.setValueAtTime(freq, audioRef.ctx.currentTime);
            g.gain.setValueAtTime(0, audioRef.ctx.currentTime);
            g.gain.linearRampToValueAtTime(0.3, audioRef.ctx.currentTime + 0.02);
            g.gain.exponentialRampToValueAtTime(0.01, audioRef.ctx.currentTime + duration);
            o.connect(g); g.connect(audioRef.ctx.destination);
            o.start(); o.stop(audioRef.ctx.currentTime + duration);
        };

        const playBgm = () => {
            if (!audioRef.ctx) audioRef.ctx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioRef.bgmTimer) return;
            const melody = [261, 329, 392, 523, 392, 329]; let i = 0;
            const loop = () => {
                if (!audioRef.isBgmOn) return;
                const o = audioRef.ctx.createOscillator();
                const g = audioRef.ctx.createGain();
                o.type = 'sine'; o.frequency.setValueAtTime(melody[i], audioRef.ctx.currentTime);
                g.gain.setValueAtTime(0, audioRef.ctx.currentTime);
                g.gain.linearRampToValueAtTime(0.04, audioRef.ctx.currentTime + 0.1);
                g.gain.linearRampToValueAtTime(0, audioRef.ctx.currentTime + 0.6);
                o.connect(g); g.connect(audioRef.ctx.destination);
                o.start(); o.stop(audioRef.ctx.currentTime + 0.7);
                i = (i + 1) % melody.length;
                audioRef.bgmTimer = setTimeout(loop, 900);
            };
            audioRef.isBgmOn = true; loop();
        };

        const stopBgm = () => {
            audioRef.isBgmOn = false;
            if (audioRef.bgmTimer) clearTimeout(audioRef.bgmTimer);
            audioRef.bgmTimer = null;
        };

        const App = () => {
            const [gameState, setGameState] = useState('menu');
            const [score, setScore] = useState(0);
            const [timeLeft, setTimeLeft] = useState(30);
            const [currentTask, setCurrentTask] = useState(null);
            const [feedback, setFeedback] = useState(null);
            const [selectedSong, setSelectedSong] = useState(null);
            const [songIndex, setSongIndex] = useState(0);
            const [activeKey, setActiveKey] = useState(null);
            const [isAutoPlaying, setIsAutoPlaying] = useState(false);
            const [bgmEnabled, setBgmEnabled] = useState(false);
            const [leaderboards, setLeaderboards] = useState({});
            const [lastSessionId, setLastSessionId] = useState(null);
            const [showRanking, setShowRanking] = useState(null);
            const autoPlayRef = useRef(null);

            useEffect(() => {
                const saved = localStorage.getItem('baby_fun_ranks_v15');
                if (saved) setLeaderboards(JSON.parse(saved));
            }, []);

            const speak = (text, lang = 'zh-TW') => {
                window.speechSynthesis.cancel();
                const ut = new SpeechSynthesisUtterance(text);
                ut.lang = lang;
                window.speechSynthesis.speak(ut);
            };

            const toggleFullscreen = () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(() => {});
                } else {
                    document.exitFullscreen();
                }
            };

            const saveScore = (gameId, finalScore) => {
                const newId = Date.now();
                setLastSessionId(newId);
                const currentRanks = { ...leaderboards };
                const list = currentRanks[gameId] || [];
                list.push({ id: newId, score: finalScore, date: new Date().toLocaleDateString() });
                list.sort((a,b) => b.score - a.score);
                currentRanks[gameId] = list.slice(0, 20); 
                setLeaderboards({...currentRanks});
                localStorage.setItem('baby_fun_ranks_v15', JSON.stringify(currentRanks));
                return newId;
            };

            const clearRanking = (gameId) => {
                const currentRanks = { ...leaderboards };
                currentRanks[gameId] = [];
                setLeaderboards(currentRanks);
                localStorage.setItem('baby_fun_ranks_v15', JSON.stringify(currentRanks));
            };

            const nextTask = (mode) => {
                if (mode === 'math') {
                    const ans = Math.floor(Math.random() * 9) + 1;
                    const a = Math.floor(Math.random() * ans);
                    setCurrentTask({ q: `${a} + ${ans-a} = ?`, ans, options: [ans, ans+1, ans-1, ans+2].sort(() => Math.random() - 0.5).filter(n => n >= 0) });
                } else if (mode === 'bopo') {
                    const target = BOPO_DATA[Math.floor(Math.random() * BOPO_DATA.length)];
                    const others = BOPO_DATA.filter(b => b.zy !== target.zy).sort(() => Math.random() - 0.5).slice(0, 3);
                    setCurrentTask({ char: target.char, zy: target.zy, options: [target.zy, ...others.map(o => o.zy)].sort(() => Math.random() - 0.5) });
                    speak(target.char);
                } else if (mode === 'english') {
                    const target = ENGLISH_DATA[Math.floor(Math.random() * ENGLISH_DATA.length)];
                    const others = ENGLISH_DATA.filter(e => e.w !== target.w).sort(() => Math.random() - 0.5).slice(0, 3);
                    setCurrentTask({ ans: target, options: [target, ...others].sort(() => Math.random() - 0.5) });
                    speak(target.w, 'en-US');
                } else if (mode === 'clock') {
                    const h = Math.floor(Math.random() * 12) + 1; const m = Math.random() > 0.5 ? 0 : 30;
                    const ans = `${h}:${m === 0 ? '00' : '30'}`;
                    setCurrentTask({ h, m, ans, options: [ans, `${(h%12)+1}:00`, `${h}:45`, `${h-1}:30`].sort(() => Math.random() - 0.5) });
                }
            };

            useEffect(() => {
                const handleOrientation = async () => {
                    try {
                        if (gameState === 'piano_play') {
                            if (document.documentElement.requestFullscreen) await document.documentElement.requestFullscreen();
                            if (screen.orientation && screen.orientation.lock) await screen.orientation.lock('landscape');
                        } else {
                            if (screen.orientation && screen.orientation.lock) await screen.orientation.lock('portrait');
                        }
                    } catch (e) {}
                };
                handleOrientation();
                if (gameState !== 'piano_play') stopAutoPlay();
            }, [gameState]);

            const startGame = (mode) => {
                setGameState(mode); setScore(0); setTimeLeft(30); setLastSessionId(null);
                if (!['piano_menu', 'piano_play'].includes(mode)) nextTask(mode);
            };

            useEffect(() => {
                let timer;
                const activeGame = ['math', 'bopo', 'english', 'clock'].includes(gameState);
                if (activeGame && timeLeft > 0) {
                    timer = setInterval(() => setTimeLeft(t => t - 1), 1000);
                } else if (timeLeft === 0 && activeGame) {
                    saveScore(gameState, score);
                    setGameState('gameover');
                }
                return () => clearInterval(timer);
            }, [gameState, timeLeft, score]);

            useEffect(() => {
                if (bgmEnabled) playBgm(); else stopBgm();
            }, [bgmEnabled]);

            const checkAnswer = (val) => {
                let isCorrect = false;
                if (gameState === 'math') isCorrect = (val === currentTask.ans);
                else if (gameState === 'bopo') isCorrect = (val === currentTask.zy);
                else if (gameState === 'english') isCorrect = (val.w === currentTask.ans.w);
                else if (gameState === 'clock') isCorrect = (val === currentTask.ans);

                if (isCorrect) {
                    setScore(s => s + 1); setFeedback('correct'); playNote(880, 0.2);
                    setTimeout(() => { setFeedback(null); nextTask(gameState); }, 600);
                } else {
                    setFeedback('wrong'); playNote(220, 0.2);
                    setTimeout(() => setFeedback(null), 600);
                }
            };

            const handleKeyInput = (idx) => {
                const k = PIANO_LAYOUT[idx];
                playNote(k.f);
                setActiveKey(idx);
                setTimeout(() => setActiveKey(null), 150);

                if (gameState === 'piano_play' && !isAutoPlaying) {
                    if (idx === selectedSong.notes[songIndex][0]) {
                        if (songIndex === selectedSong.notes.length - 1) {
                            setScore(s => s + 10);
                            setFeedback('correct');
                            setTimeout(() => { setFeedback(null); setGameState('piano_menu'); }, 1000);
                        } else {
                            setSongIndex(s => s + 1);
                        }
                    }
                }
            };

            const startAutoPlay = () => {
                if (isAutoPlaying) { stopAutoPlay(); return; }
                setIsAutoPlaying(true); let idx = 0;
                const loop = () => {
                    if (idx < selectedSong.notes.length) {
                        const [noteIdx, beats] = selectedSong.notes[idx];
                        playNote(PIANO_LAYOUT[noteIdx].f, beats * 0.8);
                        setActiveKey(noteIdx); setSongIndex(idx); idx++;
                        autoPlayRef.current = setTimeout(() => { setActiveKey(null); loop(); }, 500 * beats);
                    } else { setIsAutoPlaying(false); }
                }; loop();
            };

            const stopAutoPlay = () => {
                setIsAutoPlaying(false);
                if (autoPlayRef.current) {
                    clearTimeout(autoPlayRef.current);
                    autoPlayRef.current = null;
                }
                setActiveKey(null);
            };

            const RankingModal = ({ gameId, onClose, highlightId }) => {
                const list = leaderboards[gameId] || [];
                return (
                    <div className="fixed inset-0 bg-black/70 backdrop-blur-md z-[200] flex items-center justify-center p-6">
                        <div className="bg-white rounded-[2.5rem] p-6 w-full max-w-sm shadow-2xl space-y-4">
                            <div className="flex justify-between items-center">
                                <h3 className="text-2xl font-black text-amber-500">ğŸ† TOP 20 æ’è¡Œ</h3>
                                <button onClick={() => { if(confirm("ç¢ºå®šæ¸…é™¤æ‰€æœ‰æ’è¡Œæ•¸æ“šå—ï¼Ÿ")) clearRanking(gameId); }} className="text-xs bg-red-50 text-red-400 px-3 py-1 rounded-full font-bold">æ¸…é™¤æ’è¡Œ</button>
                            </div>
                            <div className="space-y-2 max-h-80 overflow-y-auto no-scrollbar py-2">
                                {list.length === 0 ? <div className="text-stone-300 py-10 text-center">å°šç„¡æ•¸æ“š</div> : 
                                    list.map((it,ix) => (
                                        <div key={it.id} className={`flex justify-between items-center p-3 rounded-2xl font-bold transition-all ${it.id === highlightId ? 'rank-highlight' : 'bg-stone-50'}`}>
                                            <span className="w-8 text-stone-400">#{ix+1}</span>
                                            <span className="flex-1 text-left ml-2 text-stone-600">{it.date}</span>
                                            <span className="text-amber-500 text-xl">{it.score}</span>
                                        </div>
                                    ))}
                            </div>
                            <button onClick={onClose} className="w-full bg-stone-800 text-white py-4 rounded-3xl font-bold text-xl btn-active">è¿”å›ä¸»é¸å–®</button>
                        </div>
                    </div>
                );
            };

            const VerticalZhuyin = ({ zy }) => {
                const parts = zy.split(' ');
                return (
                    <div className="flex gap-2">
                        {parts.map((p, i) => {
                            const tones = ['ËŠ', 'Ë‡', 'Ë‹', 'Ë™']; let main = []; let tone = ''; let cls = '';
                            for (let c of p) {
                                if (tones.includes(c)) { tone = c; cls = c==='ËŠ'?'tone-2':c==='Ë‡'?'tone-3':c==='Ë‹'?'tone-4':'tone-light'; }
                                else if (c !== ' ') main.push(c);
                            }
                            return (
                                <div key={i} className="zy-fixed-box scale-90">
                                    <div className="zy-main-stack">{main.map((s,i)=><span key={i}>{s}</span>)}</div>
                                    {tone && <div className={`zy-tone-mark ${cls}`}>{tone}</div>}
                                </div>
                            );
                        })}
                    </div>
                );
            };

            const StaffDisplay = ({ note }) => (
                <svg width="340" height="150" viewBox="0 0 280 120" className="bg-white rounded-[2rem] shadow-inner border border-stone-100">
                    {[25, 40, 55, 70, 85].map((y, i) => <line key={i} x1="10" y1={y} x2="270" y2={y} stroke="#bbb" strokeWidth="2.5" />)}
                    <text x="15" y="90" fontSize="80" fill="#aaa" style={{ fontFamily: 'serif' }}>ğ„</text>
                    {note && (
                        <g transform={`translate(150, ${note.staffY * 1.5 - 45})`}>
                            {note.acc === '#' && <text x="-40" y="15" fontSize="45" fill="#3b82f6" fontWeight="900">#</text>}
                            {note.ledger && <line x1="-25" y1="0" x2="25" y2="0" stroke="#444" strokeWidth="5" />}
                            <ellipse cx="0" cy="0" rx="16" ry="12" fill="#3b82f6" transform="rotate(-20)" />
                            <line x1="14" y1="0" x2="14" y2="-65" stroke="#444" strokeWidth="4" />
                        </g>
                    )}
                </svg>
            );

            if (gameState === 'menu') {
                return (
                    <div className="flex flex-col items-center justify-center min-h-screen p-6 bg-[#fafaf5]">
                        <div className="text-center mb-8 shrink-0">
                            <div className="text-6xl mb-4 animate-bounce">ğŸ¡</div>
                            <h1 className="text-4xl font-black text-stone-700">å°å¯¶è²éŠæ¨‚åœ’</h1>
                            <div className="flex gap-2 justify-center mt-3">
                                <button onClick={()=>setBgmEnabled(!bgmEnabled)} className={`p-2 rounded-2xl border-2 transition-all ${bgmEnabled?'bg-green-50 border-green-300 text-green-500 bgm-pulse':'text-stone-300 border-stone-200'}`}>ğŸµ BGM</button>
                                <button onClick={toggleFullscreen} className="p-2 rounded-2xl border-2 border-stone-200 text-stone-500">ğŸ“± å…¨è¢å¹•</button>
                            </div>
                        </div>
                        <div className="scroll-container no-scrollbar w-full max-w-xs space-y-3">
                            {[
                                { id: 'math', label: 'æ•¸å­¸ç·´ç¿’', icon: 'ğŸ§ ', color: 'bg-rose-50 text-rose-400 border-rose-100' },
                                { id: 'bopo', label: 'æ³¨éŸ³ç·´ç¿’', icon: 'ğŸ“š', color: 'bg-blue-50 text-blue-400 border-blue-100' },
                                { id: 'english', label: 'è‹±æ–‡ç·´ç¿’', icon: 'ğŸŒ', color: 'bg-emerald-50 text-emerald-400 border-emerald-100' },
                                { id: 'clock', label: 'çœ‹æ™‚é˜', icon: 'â°', color: 'bg-yellow-50 text-yellow-500 border-yellow-100' },
                                { id: 'piano_menu', label: 'é‹¼ç´æ¨‚è­œ', icon: 'ğŸ¹', color: 'bg-purple-50 text-purple-400 border-purple-100' }
                            ].map(btn => (
                                <div key={btn.id} className="relative">
                                    <button onClick={() => startGame(btn.id)} className={`${btn.color} border-2 p-4 rounded-[2rem] flex items-center justify-between btn-active w-full font-black text-xl shadow-sm`}>
                                        <span>{btn.icon}</span> <span className="flex-1 text-center">{btn.label}</span>
                                    </button>
                                    {btn.id !== 'piano_menu' && (
                                        <button onClick={()=>setShowRanking(btn.id)} className="absolute -right-4 top-1/2 -translate-y-1/2 bg-white p-2 rounded-full shadow-lg border border-amber-200 text-xl">ğŸ†</button>
                                    )}
                                </div>
                            ))}
                        </div>
                        {showRanking && <RankingModal gameId={showRanking} onClose={()=>setShowRanking(null)} />}
                    </div>
                );
            }

            if (gameState === 'piano_menu') {
                return (
                    <div className="min-h-screen bg-[#fafaf5] p-4 flex flex-col">
                        <div className="flex items-center mb-6"><button onClick={()=>setGameState('menu')} className="bg-white p-3 rounded-2xl shadow-sm text-2xl mr-4">ğŸ </button><h2 className="text-2xl font-black text-stone-600">å…’æ­Œæ¨‚è­œ (50 é¦–)</h2></div>
                        <div className="scroll-container no-scrollbar grid grid-cols-2 gap-3 pb-10">
                            {PIANO_SONGS.map((s,i)=><button key={i} onClick={()=>{setSelectedSong(s);setSongIndex(0);setGameState('piano_play');}} className="bg-white border p-4 rounded-3xl btn-active text-center shadow-sm">
                                <div className="text-[10px] text-purple-300 font-bold">[{s.cat}]</div>
                                <div className="font-black text-purple-600">{s.name}</div>
                            </button>)}
                        </div>
                    </div>
                );
            }

            if (gameState === 'gameover') {
                const gid = lastSessionId ? (currentTask?.q ? 'math' : (currentTask?.char ? 'bopo' : (currentTask?.h ? 'clock' : 'english'))) : 'math';
                return <RankingModal gameId={gid} highlightId={lastSessionId} onClose={()=>setGameState('menu')} />;
            }

            return (
                <div className="min-h-screen w-full flex flex-col bg-[#fafaf5] p-4 relative">
                    <div className="flex justify-between items-center z-50">
                        <button onClick={()=>setGameState('menu')} className="bg-white p-3 rounded-2xl shadow-sm text-xl">ğŸ </button>
                        <div className="flex gap-2">
                            {gameState !== 'piano_play' && <div className="px-4 py-2 rounded-2xl bg-white shadow-sm font-black text-xl text-rose-400">â³ {timeLeft}</div>}
                            <div className="px-4 py-2 rounded-2xl bg-white shadow-sm font-black text-xl text-amber-400">ğŸ† {score}</div>
                        </div>
                    </div>

                    <div className="flex-1 flex flex-col items-center justify-start pt-6 space-y-8">
                        {gameState === 'math' && currentTask && (
                            <><div className="text-6xl font-black text-rose-400 bg-white p-10 rounded-[3rem] shadow-sm border-4 border-rose-50">{currentTask.q}</div>
                            <div className="grid grid-cols-2 gap-4 w-full max-w-xs">{currentTask.options.map(o=><button key={o} onClick={()=>checkAnswer(o)} className="bg-white p-6 rounded-[2rem] text-4xl font-black text-rose-400 btn-active border shadow-sm">{o}</button>)}</div></>
                        )}
                        {gameState === 'bopo' && currentTask && (
                            <><div className="flex flex-col items-center gap-4">
                                <div className="bg-white px-10 py-6 rounded-[2.5rem] shadow-sm border-4 border-blue-50 flex items-center justify-center text-6xl font-black text-blue-400 tracking-widest">{currentTask.char}</div>
                                <button onClick={()=>speak(currentTask.char)} className="bg-blue-100 p-6 rounded-full text-4xl shadow-md active:scale-95">ğŸ”Š</button>
                            </div>
                            <div className="grid grid-cols-2 gap-4 w-full max-w-lg">{currentTask.options.map((o, idx)=><button key={idx} onClick={()=>checkAnswer(o)} className="btn-active flex justify-center bg-white p-4 rounded-[2rem] shadow-sm border border-stone-100"><VerticalZhuyin zy={o}/></button>)}</div></>
                        )}
                        {gameState === 'english' && currentTask && (
                            <><div className="flex flex-col items-center gap-4">
                                <div className="bg-white p-10 rounded-[4rem] text-center border-4 border-emerald-50 shadow-sm">
                                    <div className="text-[7rem] leading-none">{currentTask.ans.e}</div>
                                </div>
                                <button onClick={()=>speak(currentTask.ans.w, 'en-US')} className="bg-emerald-100 p-6 rounded-full text-4xl shadow-md active:scale-95">ğŸ”Š</button>
                            </div>
                            <div className="grid grid-cols-2 gap-4 w-full max-w-sm">{currentTask.options.map(o=><button key={o.w} onClick={()=>checkAnswer(o)} className="bg-white p-5 rounded-[2rem] btn-active text-center border shadow-sm"><div className="text-2xl font-black text-emerald-500 uppercase">{o.w}</div><div className="text-sm text-stone-400 font-bold mt-1">{o.zy}</div></button>)}</div></>
                        )}
                        {gameState === 'clock' && currentTask && (
                            <><div className="bg-white w-full max-w-xs p-6 rounded-[3rem] border-4 border-yellow-50 text-center shadow-md"><svg viewBox="0 0 100 100" className="w-48 h-48 mx-auto"><circle cx="50" cy="50" r="45" fill="white" stroke="#facc15" strokeWidth="3" />{[...Array(12)].map((_, i) => <text key={i} x={50 + 35 * Math.sin((i*30)*Math.PI/180)} y={50 - 35 * Math.cos((i*30)*Math.PI/180)} textAnchor="middle" alignmentBaseline="middle" className="text-[7px] font-bold fill-yellow-900">{i === 0 ? 12 : i}</text>)}<line x1="50" y1="50" x2={50 + 20 * Math.sin(((currentTask.h % 12) * 30 + currentTask.m * 0.5) * Math.PI / 180)} y2={50 - 20 * Math.cos(((currentTask.h % 12) * 30 + currentTask.m * 0.5) * Math.PI / 180)} stroke="black" strokeWidth="4" strokeLinecap="round" /><line x1="50" y1="50" x2={50 + 30 * Math.sin((currentTask.m * 6) * Math.PI / 180)} y2={50 - 30 * Math.cos((currentTask.m * 6) * Math.PI / 180)} stroke="#666" strokeWidth="3" strokeLinecap="round" /></svg></div>
                            <div className="grid grid-cols-2 gap-4 w-full max-w-xs">{currentTask.options.map(o=><button key={o} onClick={()=>checkAnswer(o)} className="bg-white p-5 rounded-[2rem] text-3xl font-black text-yellow-500 btn-active border shadow-sm">{o}</button>)}</div></>
                        )}
                        {gameState === 'piano_play' && selectedSong && (
                            <div className="fixed inset-0 flex items-start justify-center bg-[#fafaf5] p-2 z-[55]">
                                {/* å·¦å´è¿”å›å€ */}
                                <div className="flex flex-col justify-center h-[50vh] pr-4">
                                    <button onClick={()=>setGameState('piano_menu')} className="bg-white p-4 rounded-3xl shadow-md border border-stone-200 text-3xl active:scale-90">ğŸ </button>
                                </div>
                                
                                {/* ä¸­é–“è­œé¢å€ */}
                                <div className="flex flex-col items-center justify-center h-[50vh] max-w-[65vw]">
                                    <div className="text-sm font-black text-purple-400 mb-1">æ­£åœ¨ç·´ç¿’ï¼š{selectedSong.name}</div>
                                    <StaffDisplay note={PIANO_LAYOUT[selectedSong.notes[songIndex][0]]} />
                                </div>
                                
                                {/* å³å´ç¤ºç¯„å€ */}
                                <div className="flex flex-col justify-center h-[50vh] pl-4">
                                    <button onClick={startAutoPlay} className={`p-4 rounded-3xl shadow-md text-white text-3xl active:scale-90 ${isAutoPlaying?'bg-rose-400':'bg-purple-500'}`}>{isAutoPlaying?'â¹ï¸':'â–¶ï¸'}</button>
                                    <div className="text-[10px] text-center mt-2 font-bold text-stone-400">{isAutoPlaying?'åœæ­¢':'ç¤ºç¯„'}</div>
                                </div>

                                <div className="piano-container">{PIANO_LAYOUT.map((k,idx)=><button key={idx} className={`${k.b?'black-key':'white-key'} ${activeKey===idx?'active':''}`} onPointerDown={(e)=>{e.preventDefault(); handleKeyInput(idx);}}>{!k.b && k.n}</button>)}</div>
                            </div>
                        )}
                    </div>
                    {feedback && <div className="fixed inset-0 flex items-center justify-center z-[100] pointer-events-none text-9xl animate-ping">{feedback==='correct'?'ğŸŒŸ':'ğŸ¤”'}</div>}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

